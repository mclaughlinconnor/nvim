id: no-then-in-async-function
message: Use await in async functions
severity: error
language: typescript
rule:
  any:
    - pattern: $_.then()
    - pattern: $_.then($A)
    - pattern: $_.then($A, $B)
  inside:
    any:
      - kind: method_definition
      - kind: function_declaration
      - kind: arrow_function
    stopBy:
      kind: call_expression
      any:
        - pattern: Promise.all($$$)
        - pattern: Bluebird.props($$$)
    has: 
      regex: 'async'
      precedes:
        any:
          - regex: 'function'
          - kind: property_identifier
          - kind: formal_parameters
constraints:
  A:
    not:
      regex: 'MongooseUtil.throwIfNotFound'
